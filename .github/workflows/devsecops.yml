name: DevSecOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Build & Test (Unit Tests + Static Analysis)
  build-and-test:
    name: üèóÔ∏è Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Deps
        working-directory: ./backend
        run: npm ci

      - name: Run Backend Tests
        working-directory: ./backend
        run: npm test

      - name: Install Frontend Deps
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

  # 2. SCA - Software Composition Analysis (Security)
  security-sca:
    name: üõ°Ô∏è SCA (Dependencies)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v3
      - name: Audit Backend
        working-directory: ./backend
        run: npm audit --audit-level=critical --omit=dev
      - name: Audit Frontend
        working-directory: ./frontend
        run: npm audit --audit-level=critical --omit=dev

  # 3. Deploy to Staging (Mock)
  deploy-staging:
    name: üöÄ Deploy Staging
    runs-on: ubuntu-latest
    needs: security-sca
    steps:
      - name: Simulating Deployment
        run: echo "Deploying to Staging Env..."
      
      # In a real scenario, this would potentially trigger a Vercel/Render deploy
      # and wait for the URL to be ready.
      # For this pipeline, we will spin up the app locally in the next job for DAST.

  # 4. DAST - Dynamic Application Security Testing (OWASP ZAP)
  security-dast:
    name: üïµÔ∏è DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - uses: actions/checkout@v3

      # Serve the app locally for the scanner to attack
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install & Start Backend
        working-directory: ./backend
        run: |
          npm ci
          # Start in background using nohup or &
          # We need a build step if TS, or use tsx
          # Using 'npm run dev' is risky due to concurrent outputs, better to run directly
          npx tsx src/presentation/server.ts &
          echo "Waiting for Backend..."
          sleep 10
        env:
          PORT: 3000
          OPENAI_API_KEY: "mock-key-for-ci" # Ensure mock mode works

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:3000/'
          rules_file_name: '.zap/rules.tsv' # Optional rules
          cmd_options: '-a' # Fail on all alerts
          allow_issue_writing: false # Don't write GitHub issues (optional)
        continue-on-error: true # Don't fail the build immediately if ZAP finds low risks, adjust policy as needed

  # 5. Deploy to Production
  deploy-production:
    name: üö¢ Deploy Production
    runs-on: ubuntu-latest
    needs: security-dast
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploying Artifacts
        run: echo "Deploying to Production..."
